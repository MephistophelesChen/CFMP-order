version: '3.8'

services:
  mysql-service:
    image: mysql:8.0
    container_name: mysql-service
    environment:
      - MYSQL_ROOT_PASSWORD=root123
    volumes:
      - mysql-data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    restart: unless-stopped

  # 订单服务
  order-service:
    build:
      context: .
      dockerfile: Dockerfile.order-root
    container_name: order-service
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings
      - DEBUG=False
      - NACOS_SERVER=123.57.145.79:8848
      - ORDER_DB_HOST=mysql-service
      - ORDER_DB_NAME=cfmp_order
      - ORDER_DB_USER=root
      - ORDER_DB_PASSWORD=root123
    ports:
      - "8001:8001"
    depends_on:
      - mysql-service
    restart: unless-stopped
    volumes:
      - ./logs/order:/app/logs

  # 支付服务
  payment-service:
    build:
      context: .
      dockerfile: Dockerfile.payment-root
    container_name: payment-service
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings
      - DEBUG=False
      - NACOS_SERVER=123.57.145.79:8848
      - PAYMENT_DB_HOST=mysql-service
      - PAYMENT_DB_NAME=cfmp_payment
      - PAYMENT_DB_USER=root
      - PAYMENT_DB_PASSWORD=root123
    ports:
      - "8002:8002"
    depends_on:
      - mysql-service
    restart: unless-stopped
    volumes:
      - ./logs/payment:/app/logs

  # 通知服务
  notification-service:
    build:
      context: .
      dockerfile: Dockerfile.notification-root
    container_name: notification-service
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings
      - DEBUG=False
      - NACOS_SERVER=123.57.145.79:8848
      - NOTIFICATION_DB_HOST=mysql
      - NOTIFICATION_DB_NAME=cfmp_notification
      - NOTIFICATION_DB_USER=root
      - NOTIFICATION_DB_PASSWORD=root123
    ports:
      - "8003:8003"
    depends_on:
      - mysql
    restart: unless-stopped
    volumes:
      - ./logs/notification:/app/logs

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: redis-server
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped

volumes:
  mysql-data:
  redis-data:
